
# Распределенные системы

По мотивам [https://www.youtube.com/watch?v=wTvOEH4NaBc&feature=emb_logo](Теория распределенных вычислений)

У нас есть узлы.
Они обменивают сообщениями.
Система огорожена от пользователя контуром.

Пользователь не наблюдает распределенность. Для пользователя распределенная система - это сетевой адрес, в который он отсылает запросы.ц

Систему снаружи можно представить как `concurrent_object`. Пользователи - это потоки. Несмотря на то, что операции разных пользователей могут конкурировать во времени, у пользователя должна быть явная семантика.

`Модель согласованности` - то что видит клиент.


Абстрагируем все детали и скажем, что каждый узел, это просто автомат.

## Л2 Репликация и линеаризуемость

Модель **Asynchronous Model**, no bounds on:
- message delays
- clock diff
- speed of nodes
Модель отказа: узлы просто выходят из строя и не возвращаются

Api:
```
- Set(k, v)
- Get(k)
```

Отказаустойчивость обеспечитвается избыточностью. Сообщения между репликами передаются не мгновенно, значит они не могут быть полностью синхронизированы.

Модель согласованности - какое поведение мы наблюдаем в случае, когда конфликтующие операции пересеукаются во времени.

Система порождает последовательности событий (Concurrent history).

Последовательная спецификация (Sequential spec) - набор последовательных историй, которые мы хотим допустить.

Самая сильная модель согласованности - линеаризуемость `linearizability`. Система линеаризуема, когда для каждой конкурентной истории, которые порождает реализация, найдется линейная история, в которой те же самые вызовы возвращают те же результаты и сохранен порядок вызовов, которые не пересекаются в физическом времени.

Отношение `happens before`.

## Л3

Atomic broadcast (Totaly order broadcast)
- Validity - если несбойный узел инициирует broadcast, то этот broadcast доставит сообщение на этот узел
- Agreement - если несбойный узел получил сообщение, то все несбойные узлы получили это сообщение
- Total Order - все получают сообщения в одном и том же порядке

Exactly once семантика

Сведение задач: Replication -> Atomic Broadcast -> Consensus

Задача консунсуса: Есть N узлов, у каждого есть входное значение. Узлам нужно договориться об одном значении.
- Agreement - должны придти к согласию
- Validity - должны выбрать одно из существующих значений, нельзя выдумывать новые
- Termination - алгоритм должен завершаться

Reliable broadcast - широковешательная рассылка, позволяет доставить всем сообщение, без учета порядка.

FLP теорема.
- Async model, асинхронная модель
- Determenistic algo on nodes, детерминированный алгоритм на узлах
- f <= 1, возможно не более 1 сбоя
То нельзя гарантировать выполнение всех свойств консенсуса. Т.е. если возможны отказы, то существует исполнение, в котором протокол не завершается. В любом алгоритме консенсуса обязательно будет live-lock.

### Paxos
[Leslie Lamport, 1990, Part Time Parliament]

### Replicated Log
- ViewStamp Replication (1988)
- MultiPaxos
- RAFT (2014)
- ZAB (Zookeeper Atomic Broadcast, 2012)

**Multipaxos**

Решени проблем:
- Exponential Time Decay
- Leader Elaction, например каждый узел шлет heartbit остальным, узел со старшим id считает себя лидером

---
Reading list:
- Consistency Models https://jepsen.io/consistency
- Strong consistency models https://aphyr.com/posts/313-strong-consistency-models
